# Как добавить PostgreSQL базу данных в Railway

## Шаг 1: Добавление базы данных

1. **Откройте Railway Dashboard**
   - Зайдите на https://railway.app
   - Войдите в свой аккаунт
   - Выберите проект `up11`

2. **Создайте новую базу данных:**
   - В правом верхнем углу нажмите зеленую кнопку **"+ New"** (или **"Add Service"**)
   - В выпадающем меню выберите **"Database"**
   - Выберите **"Add PostgreSQL"**

3. **Railway автоматически:**
   - Создаст PostgreSQL базу данных
   - Добавит переменную `DATABASE_URL` в ваш сервис
   - Подключит базу к вашему Django проекту

## Шаг 2: Проверка подключения

1. **Проверьте переменные окружения:**
   - Откройте ваш Django сервис (не базу данных, а сам сервис)
   - Перейдите в **Settings** → **Variables**
   - Убедитесь, что там есть переменная `DATABASE_URL`
   - Она должна выглядеть примерно так:
     ```
     postgresql://postgres:password@hostname:5432/railway
     ```

2. **Если переменной нет:**
   - Railway должен был добавить её автоматически
   - Если её нет, проверьте, что база данных и сервис находятся в одном проекте
   - Можно добавить вручную, скопировав значение из настроек базы данных

## Шаг 3: Выполнение миграций

После добавления базы данных нужно выполнить миграции Django:

### Вариант 1: Через Railway Shell (веб-интерфейс)

1. Откройте ваш Django сервис в Railway
2. Нажмите на три точки (⋮) в правом верхнем углу
3. Выберите **"Open Shell"** или **"Shell"**
4. В открывшейся консоли выполните:
   ```bash
   python manage.py migrate
   python manage.py collectstatic --noinput
   python manage.py createsuperuser
   ```

### Вариант 2: Через Railway CLI

1. Установите Railway CLI (если еще не установлен):
   ```bash
   npm i -g @railway/cli
   ```

2. Войдите в Railway:
   ```bash
   railway login
   ```

3. Подключитесь к проекту:
   ```bash
   railway link
   ```

4. Выполните команды:
   ```bash
   railway run python manage.py migrate
   railway run python manage.py collectstatic --noinput
   railway run python manage.py createsuperuser
   ```

## Шаг 4: Проверка работы базы данных

1. **Проверьте логи:**
   - В Railway откройте ваш сервис
   - Перейдите во вкладку **"Deployments"**
   - Откройте последний деплой
   - Проверьте логи на наличие ошибок подключения к БД

2. **Проверьте работу сайта:**
   - Откройте ваш сайт (Railway предоставит URL)
   - Попробуйте зарегистрироваться или войти
   - Если всё работает - база данных подключена правильно!

## Важные замечания:

⚠️ **Безопасность:**
- `DATABASE_URL` содержит пароль от базы данных
- Никогда не коммитьте его в Git
- Railway автоматически скрывает его в интерфейсе

⚠️ **Миграции:**
- Миграции нужно выполнять после каждого деплоя, если были изменения в моделях
- Или настроить автоматическое выполнение миграций при деплое

⚠️ **Резервное копирование:**
- Railway автоматически делает бэкапы PostgreSQL
- Но рекомендуется настроить дополнительные бэкапы для важных данных

## Автоматическое выполнение миграций (опционально)

Можно настроить автоматическое выполнение миграций при каждом деплое:

1. В Railway откройте ваш сервис
2. Перейдите в **Settings** → **Deploy**
3. Найдите **"Post Deploy Command"**
4. Добавьте:
   ```bash
   python manage.py migrate
   ```

Или обновите `Dockerfile`, добавив миграции перед запуском:

```dockerfile
# После сборки статики
RUN python manage.py collectstatic --noinput

# Выполнение миграций (опционально, лучше через Railway)
# RUN python manage.py migrate --noinput

CMD gunicorn shop_project.wsgi:application --bind 0.0.0.0:$PORT
```

## Просмотр данных в базе

1. В Railway откройте вашу PostgreSQL базу данных
2. Перейдите во вкладку **"Data"** или **"Connect"**
3. Там будет информация для подключения через клиент PostgreSQL
4. Или используйте Railway Data Proxy для прямого доступа

## Устранение проблем

### Ошибка подключения к БД:
- Проверьте, что `DATABASE_URL` добавлен в переменные окружения
- Убедитесь, что база данных и сервис в одном проекте
- Проверьте логи на наличие ошибок

### Ошибка миграций:
- Убедитесь, что база данных создана и доступна
- Проверьте, что все зависимости установлены
- Выполните миграции вручную через Shell

### База данных не видна:
- Обновите страницу в Railway
- Проверьте, что база создана в правильном проекте
- Попробуйте пересоздать базу данных

